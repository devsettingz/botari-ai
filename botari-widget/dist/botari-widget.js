!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).BotariWidget={})}(this,function(t){"use strict";class e{constructor(t){this.conversationId=null,this.config={apiUrl:t.apiUrl||"http://localhost:4000",apiKey:t.apiKey,businessId:t.businessId}}getConversationId(){return this.conversationId}setConversationId(t){this.conversationId=t}getHeaders(){return{"Content-Type":"application/json","X-API-Key":this.config.apiKey,"X-Business-ID":String(this.config.businessId)}}async createConversation(t){const e=await fetch(`${this.config.apiUrl}/api/conversations`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({customer_name:(null==t?void 0:t.name)||"Website Visitor",customer_phone:(null==t?void 0:t.phone)||"",employee_id:1})});if(!e.ok){const t=await e.json().catch(()=>({error:"Unknown error"}));throw new Error(t.error||`Failed to create conversation: ${e.status}`)}const i=await e.json();return this.conversationId=i.conversation_id,i.conversation_id}async getMessages(t){const e=t||this.conversationId;if(!e)throw new Error("No conversation ID available");const i=await fetch(`${this.config.apiUrl}/api/conversations/${e}/messages`,{method:"GET",headers:this.getHeaders()});if(!i.ok){const t=await i.json().catch(()=>({error:"Unknown error"}));throw new Error(t.error||`Failed to get messages: ${i.status}`)}return i.json()}async sendMessage(t,e="user"){this.conversationId||await this.createConversation();const i=await fetch(`${this.config.apiUrl}/api/messages`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({conversation_id:this.conversationId,sender:e,text:t})});if(!i.ok){const t=await i.json().catch(()=>({error:"Unknown error"}));throw new Error(t.error||`Failed to send message: ${i.status}`)}return(await i.json()).reply}async closeConversation(t){const e=t||this.conversationId;if(!e)return;(await fetch(`${this.config.apiUrl}/api/conversations/${e}/close`,{method:"PUT",headers:this.getHeaders()})).ok||console.error("Failed to close conversation"),this.conversationId=null}async healthCheck(){try{return(await fetch(`${this.config.apiUrl}/health`,{method:"GET",headers:{"X-API-Key":this.config.apiKey}})).ok}catch{return!1}}}const i={chat:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>',close:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',send:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4z"/><path d="M22 2 11 13"/></svg>',clear:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>',user:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'};class s{constructor(t){if(this.state="closed",this.messages=[],this.container=null,this.button=null,this.window=null,this.messagesContainer=null,this.input=null,this.isTyping=!1,this.autoOpenTimer=null,this.customerName="You",!t.businessId)throw new Error("BotariWidget: businessId is required");if(!t.apiKey)throw new Error("BotariWidget: apiKey is required");this.config={businessId:t.businessId,apiKey:t.apiKey,apiUrl:t.apiUrl||"http://localhost:4000",position:t.position||"bottom-right",primaryColor:t.primaryColor||"#E2725B",welcomeMessage:t.welcomeMessage||"Hello! How can I help you today?",botName:t.botName||"Botari Assistant",businessName:t.businessName||"Botari AI",placeholder:t.placeholder||"Type a message...",autoOpen:t.autoOpen||0,soundEnabled:!1!==t.soundEnabled,customClass:t.customClass||""},this.api=new e(this.config),this.storageKey=`botari_widget_${this.config.businessId}`,this.restoreState()}init(){this.container?console.warn("BotariWidget: Already initialized"):(this.createDOM(),this.attachEvents(),this.applyCustomStyles(),this.config.autoOpen>0&&(this.autoOpenTimer=window.setTimeout(()=>{this.open()},this.config.autoOpen)),this.initializeConversation())}createDOM(){this.container=document.createElement("div"),this.container.className=`botari-widget botari-widget--${this.config.position} ${this.config.customClass}`,this.container.setAttribute("role","region"),this.container.setAttribute("aria-label","Botari Chat Widget"),this.button=document.createElement("button"),this.button.className="botari-widget__button",this.button.setAttribute("aria-label","Open chat"),this.button.innerHTML=i.chat,this.container.appendChild(this.button),this.window=document.createElement("div"),this.window.className="botari-widget__window",this.window.setAttribute("role","dialog"),this.window.setAttribute("aria-label","Chat with us");const t=document.createElement("div");t.className="botari-widget__header",t.innerHTML=`\n      <div class="botari-widget__header-info">\n        <div class="botari-widget__avatar">${this.config.botName.charAt(0)}</div>\n        <div class="botari-widget__header-text">\n          <h3 class="botari-widget__bot-name">${this.config.botName}</h3>\n          <span class="botari-widget__status">\n            <span class="botari-widget__status-dot"></span>\n            Online\n          </span>\n        </div>\n      </div>\n      <div class="botari-widget__header-actions">\n        <button class="botari-widget__header-btn" data-action="clear" title="Clear chat" aria-label="Clear chat">\n          ${i.clear}\n        </button>\n        <button class="botari-widget__header-btn" data-action="close" title="Close chat" aria-label="Close chat">\n          ${i.close}\n        </button>\n      </div>\n    `,this.window.appendChild(t),this.messagesContainer=document.createElement("div"),this.messagesContainer.className="botari-widget__messages",this.window.appendChild(this.messagesContainer);const e=document.createElement("div");e.className="botari-widget__input-area",e.innerHTML=`\n      <textarea \n        class="botari-widget__input" \n        placeholder="${this.config.placeholder}"\n        rows="1"\n        aria-label="Message"\n      ></textarea>\n      <button class="botari-widget__send-btn" aria-label="Send message">\n        ${i.send}\n      </button>\n    `,this.window.appendChild(e);const s=document.createElement("div");s.className="botari-widget__powered",s.innerHTML=`Powered by <a href="https://botari.ai" target="_blank" rel="noopener">${this.config.businessName}</a>`,this.window.appendChild(s),this.container.appendChild(this.window),this.input=e.querySelector(".botari-widget__input"),document.body.appendChild(this.container),this.showWelcomeMessage()}attachEvents(){if(!this.button||!this.window||!this.input)return;this.button.addEventListener("click",()=>this.toggle()),this.window.addEventListener("click",t=>{const e=t.target.closest("[data-action]");if(e){const t=e.getAttribute("data-action");"close"===t&&this.close(),"clear"===t&&this.clear()}});this.window.querySelector(".botari-widget__send-btn").addEventListener("click",()=>this.handleSend()),this.input.addEventListener("keydown",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.handleSend())}),this.input.addEventListener("input",()=>{this.input.style.height="auto",this.input.style.height=Math.min(this.input.scrollHeight,120)+"px"}),document.addEventListener("click",t=>{const e=t.target;"open"!==this.state||this.window.contains(e)||this.button.contains(e)||this.close()})}applyCustomStyles(){"#E2725B"!==this.config.primaryColor&&this.container&&this.container.style.setProperty("--botari-primary",this.config.primaryColor)}showWelcomeMessage(){0===this.messages.length&&this.addMessage({id:"welcome",conversation_id:0,sender:"bot",text:this.config.welcomeMessage,created_at:(new Date).toISOString()})}async initializeConversation(){try{const t=localStorage.getItem(`${this.storageKey}_conversation_id`);if(t)this.api.setConversationId(parseInt(t,10));else{const t=await this.api.createConversation({name:this.customerName});localStorage.setItem(`${this.storageKey}_conversation_id`,String(t))}}catch(t){console.error("BotariWidget: Failed to initialize conversation",t),this.showError("Failed to start conversation. Please try again.")}}async handleSend(){if(!this.input||this.isTyping)return;const t=this.input.value.trim();t&&(this.input.value="",this.input.style.height="auto",await this.sendMessage(t))}async sendMessage(t){this.addMessage({id:Date.now().toString(),conversation_id:this.api.getConversationId()||0,sender:"user",text:t,created_at:(new Date).toISOString()}),this.showTypingIndicator();try{const e=await this.api.sendMessage(t,"user");this.hideTypingIndicator(),this.addMessage({id:(Date.now()+1).toString(),conversation_id:this.api.getConversationId()||0,sender:"bot",text:e,created_at:(new Date).toISOString()}),this.config.soundEnabled&&this.playNotificationSound()}catch(e){this.hideTypingIndicator(),console.error("BotariWidget: Failed to send message",e),this.showError("Failed to send message. Please try again.")}}addMessage(t){if(this.messages.push(t),!this.messagesContainer)return;const e="bot"===t.sender||"botari"===t.sender,s=document.createElement("div");s.className="botari-widget__message botari-widget__message--"+(e?"bot":"user");const n=e?"ðŸ¤–":i.user,o=new Date(t.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});s.innerHTML=`\n      <div class="botari-widget__message-avatar">\n        ${e?n:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'}\n      </div>\n      <div class="botari-widget__message-content">\n        <div class="botari-widget__message-bubble">${this.escapeHtml(t.text)}</div>\n        <span class="botari-widget__message-time">${o}</span>\n      </div>\n    `,this.messagesContainer.appendChild(s),this.scrollToBottom()}showTypingIndicator(){if(this.isTyping=!0,!this.messagesContainer)return;const t=document.createElement("div");t.className="botari-widget__typing",t.id="botari-typing-indicator",t.innerHTML='\n      <div class="botari-widget__message-avatar">ðŸ¤–</div>\n      <div class="botari-widget__typing-dots">\n        <span class="botari-widget__typing-dot"></span>\n        <span class="botari-widget__typing-dot"></span>\n        <span class="botari-widget__typing-dot"></span>\n      </div>\n    ',this.messagesContainer.appendChild(t),this.scrollToBottom()}hideTypingIndicator(){this.isTyping=!1;const t=document.getElementById("botari-typing-indicator");t&&t.remove()}showError(t){if(!this.messagesContainer)return;const e=document.createElement("div");e.className="botari-widget__error",e.textContent=t,this.messagesContainer.appendChild(e),this.scrollToBottom(),setTimeout(()=>e.remove(),5e3)}scrollToBottom(){this.messagesContainer&&(this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight)}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}playNotificationSound(){try{const t=new(window.AudioContext||window.webkitAudioContext),e=t.createOscillator(),i=t.createGain();e.connect(i),i.connect(t.destination),e.frequency.value=800,e.type="sine",i.gain.value=.1,e.start(),e.stop(t.currentTime+.1)}catch{}}restoreState(){const t=localStorage.getItem(`${this.storageKey}_customer_name`);t&&(this.customerName=t)}saveState(){localStorage.setItem(`${this.storageKey}_customer_name`,this.customerName)}open(){"open"!==this.state&&this.window&&this.button&&(this.state="open",this.window.classList.add("botari-widget__window--open"),this.button.innerHTML=i.close,this.button.setAttribute("aria-label","Close chat"),this.input&&setTimeout(()=>{var t;return null==(t=this.input)?void 0:t.focus()},100),this.saveState())}close(){"closed"!==this.state&&this.window&&this.button&&(this.state="closed",this.window.classList.remove("botari-widget__window--open"),this.button.innerHTML=i.chat,this.button.setAttribute("aria-label","Open chat"),this.saveState())}toggle(){"open"===this.state?this.close():this.open()}clear(){this.messages=[],this.messagesContainer&&(this.messagesContainer.innerHTML=""),this.showWelcomeMessage(),localStorage.removeItem(`${this.storageKey}_conversation_id`),this.initializeConversation()}destroy(){this.autoOpenTimer&&clearTimeout(this.autoOpenTimer),this.api.closeConversation(),this.container&&this.container.remove(),this.container=null,this.button=null,this.window=null,this.messagesContainer=null,this.input=null}}const n=new Map;function o(t){const e=`${t.businessId}_${Date.now()}`,i=new s(t);return i.init(),n.set(e,i),"undefined"!=typeof window&&(window.__botariWidget=i),i}function a(){const t=Array.from(n.values());return t[t.length-1]}function r(){n.forEach(t=>t.destroy()),n.clear(),"undefined"!=typeof window&&delete window.__botariWidget}const d="1.0.0",c={init:o,getInstance:a,destroyAll:r,version:d};if("undefined"!=typeof window){const t=window;t.BotariWidget=c,t.BOTARI_WIDGET_CONFIG&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{o(t.BOTARI_WIDGET_CONFIG)}):o(t.BOTARI_WIDGET_CONFIG))}t.default=c,t.destroyAll=r,t.getInstance=a,t.init=o,t.version=d,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
//# sourceMappingURL=botari-widget.js.map
